<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Mali OpenGL ES SDK v2.4.4: Shadow Mapping</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="top_banner.bmp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Mali OpenGL ES SDK v2.4.4
<span id="malidevcenter"><a href="http://malideveloper.arm.com">Mali Developer Center</a></span>
   </div>
    <a id="eula" href="http://malideveloper.arm.com/develop-for-mali/mali-opengl-es-sdk-for-linux-end-user-licence-agreement-eula/
">Use of the code snippets present within these pages are subject to these EULA terms</a>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li class="current"><a href="pages.html"><span>Help&#160;and&#160;Tutorials</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('shadow_mapping.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Shadow Mapping </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>An approach for rendering shadows in real-time for devices using OpenGL ES 2.0 without using the OES_depth_texture extension.</p>
<div class="image">
<img src="ShadowMapHeader.png" alt="ShadowMapHeader.png"/>
</div>
<h1><a class="anchor" id="shadowMappingIntroduction"></a>
Introduction</h1>
<p>This samples shows one way of doing real-time shadow rendering using a projective texture mapping technique. The technique does as many rendering passes as the number of lights, plus one final pass to draw the objects with shadows on top of them. Lets call these passes <a class="el" href="struct_light.html">Light</a> and Normal respectively. To keep the sample as simple as possible, the number of lights has been confined to one. With only one light, two passes are required: one <a class="el" href="struct_light.html">Light</a> and one Normal pass. The distance from a given fragment to the light is calculated and stored in a texture during the <a class="el" href="struct_light.html">Light</a> pass. It is usually considered as lightweight pass since all rendering features except distance measurement are disabled. The distance is stored in the RG components of an RGBA texture since two components are sufficient to get enough precision for this example. Once the distance information has been collected, it is time to do the Normal pass where the scene is rendered from camera position, during which shadow is applied on fragments that are obscured by other fragments on their way to the light.</p>
<h1><a class="anchor" id="shadowMappingLightPass"></a>
Light Pass</h1>
<p>This section explains how to prepare a shadow texture (distance texture). The most efficient way of creating the texture is to use a Frame Buffer Object, which is available in OpenGL ES 2.0. Before the FBO is created a texture has to be created. This is then finally attached to the FBO. Create the texture as follow:</p>
<div class="fragment"><div class="line">glGenTextures(1, &amp;theNameTexture);</div>
<div class="line">glActiveTexture(GL_TEXTURE0);</div>
<div class="line">glBindTexture(GL_TEXTURE_2D, theNameTexture);</div>
<div class="line">glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, theWidth, theHeight, 0, GL_RGBA, GL_UNSIGNED_BYTE, NULL);</div>
<div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</div>
<div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</div>
<div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</div>
<div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</div>
</div><!-- fragment --><p>Now create the FBO and attach the above texture:</p>
<div class="fragment"><div class="line">glGenFramebuffers(1, &amp;theNameFBO);</div>
<div class="line">glGenRenderbuffers(1, &amp;theNameRenderBuffer);</div>
<div class="line">glBindRenderbuffer(GL_RENDERBUFFER, theNameRenderBuffer);</div>
<div class="line">glRenderbufferStorage(GL_RENDERBUFFER, GL_DEPTH_COMPONENT16, theWidth, theHeight);</div>
<div class="line">glBindFramebuffer(GL_FRAMEBUFFER, theNameFBO);</div>
<div class="line">glBindTexture(GL_TEXTURE_2D, theNameTexture);</div>
<div class="line">glFramebufferRenderbuffer(GL_FRAMEBUFFER,</div>
<div class="line">                          GL_DEPTH_ATTACHMENT,</div>
<div class="line">                          GL_RENDERBUFFER,</div>
<div class="line">                          theNameRenderBuffer);</div>
<div class="line">glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, theNameTexture, 0);</div>
<div class="line"><span class="keywordflow">if</span> (glCheckFramebufferStatus(GL_FRAMEBUFFER) != GL_FRAMEBUFFER_COMPLETE)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;Error: FrameBufferObject is not complete!\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The above creation of FBO as well as texture should be done only once during an application initialization. Once the FBO has been successfully created there is only one function to be called to change rendering destination from FBO to framebuffer and vice versa, which is glBindFrameBuffer:</p>
<p>Binding FBO:</p>
<div class="fragment"><div class="line">glBindFramebuffer(GL_FRAMEBUFFER, theNameFBO);</div>
</div><!-- fragment --><p>Binding framebuffer - unbinding FBO:</p>
<div class="fragment"><div class="line">glBindFramebuffer(GL_FRAMEBUFFER, 0);</div>
</div><!-- fragment --><h1><a class="anchor" id="shadowMappingNormalPass"></a>
Normal Pass</h1>
<p>Now the FBO is set up and ready, the scene can be rendered to it from the <a class="el" href="struct_light.html">Light</a> position in order to collect information about distance of fragments to the <a class="el" href="struct_light.html">Light</a>. This can be done by outputting a distance value instead of colour from a fragment program. First we have to set up the vertex and fragment programs to output the distance.</p>
<p><a class="el" href="struct_vertex.html">Vertex</a> program, which passes the screen position of a vertex to the fragment program:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#version 100</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">attribute <a class="code" href="structvec4.html">vec4</a> <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8vert.html#aad7497bbca5d4d9f90e5a1503a832127">a_v4Position</a>;</div>
<div class="line"><a class="code" href="glutil_8cpp.html#a2c5c3c4ce30783b590dd30b1060b7b38">uniform</a> <a class="code" href="structmat4.html">mat4</a> <a class="code" href="_shadow_map__shadow_8vert.html#aa7205e594dcebe34b83e7c1afa01fe4a">u_m4LightMVP</a>;</div>
<div class="line">varying <a class="code" href="structvec4.html">vec4</a> <a class="code" href="_shadow_map__shadow_8frag.html#a796451b3e0aeefd7f2f7713dacaafbaf">v_v4TexCoord</a>;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>()</div>
<div class="line">{</div>
<div class="line">    v_v4TexCoord = u_m4LightMVP * <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8vert.html#aad7497bbca5d4d9f90e5a1503a832127">a_v4Position</a>;</div>
<div class="line">    gl_Position = u_m4LightMVP * <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8vert.html#aad7497bbca5d4d9f90e5a1503a832127">a_v4Position</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The Fragment program receives the position and packs it into RG components in order to increase precision. The assumption has been taken that the range of packing values must be in [-10, 10]. Values outside of this range will cause incorrect rendering results:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#version 100</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">precision mediump <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>;</div>
<div class="line">varying <a class="code" href="structvec4.html">vec4</a> <a class="code" href="_shadow_map__shadow_8frag.html#a796451b3e0aeefd7f2f7713dacaafbaf">v_v4TexCoord</a>;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Generate shadow map - write fragment depth. */</span></div>
<div class="line">    <span class="keywordtype">float</span> value = 10.0 - v_v4TexCoord.z;</div>
<div class="line">    <span class="keywordtype">float</span> v = floor(value);</div>
<div class="line">    <span class="keywordtype">float</span> f = value - v;</div>
<div class="line">    <span class="keywordtype">float</span> vn = v * 0.1;</div>
<div class="line">    gl_FragColor = <a class="code" href="structvec4.html">vec4</a>(vn, f, 0.0, 1.0);</div>
<div class="line">}</div>
</div><!-- fragment --><p>After the scene has been rendered to the FBO with the above shaders, the distance texture is ready to use. This is enough information to display shadows, which is what the next section is about.</p>
<p>Once the distance texture is ready, the FBO has to be unbound and the scene rendered directly to the framebuffer with all necessary features enabled such as lighting, texturing, blending etc. During this pass the shadows can be applied as well. It is possible to do an extra pass just for applying shadows but we want to avoid it since we have enough room for shadows in the same pass. To render the scene the camera has to be reset to its original position, the distance texture has to be bound as a 2D texture and all shaders must be modified to do shadows since the shadows are being rendered in the same pass as normal rendering. Below is shader code to show how the shaders should be modified:</p>
<p><a class="el" href="struct_vertex.html">Vertex</a> shader:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#version 100</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">attribute <a class="code" href="structvec4.html">vec4</a> <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8vert.html#aad7497bbca5d4d9f90e5a1503a832127">a_v4Position</a>;</div>
<div class="line"></div>
<div class="line"><a class="code" href="glutil_8cpp.html#a2c5c3c4ce30783b590dd30b1060b7b38">uniform</a> <a class="code" href="structmat4.html">mat4</a> <a class="code" href="_fur__fur_8vert.html#a614c4d221cb64b0cc409e64221172c44">u_m4MVP</a>;</div>
<div class="line"><a class="code" href="glutil_8cpp.html#a2c5c3c4ce30783b590dd30b1060b7b38">uniform</a> <a class="code" href="structmat4.html">mat4</a> <a class="code" href="_shadow_map__shadowmap_8vert.html#a7214f1e69f5b9a4254311bebd6e3e017">u_m4M</a>;</div>
<div class="line"><a class="code" href="glutil_8cpp.html#a2c5c3c4ce30783b590dd30b1060b7b38">uniform</a> <a class="code" href="structmat4.html">mat4</a> <a class="code" href="_shadow_map__shadowmap_8vert.html#a5f8bd9faaa375d502260b3ab35a2c7d2">u_m4LightV</a>;</div>
<div class="line"><a class="code" href="glutil_8cpp.html#a2c5c3c4ce30783b590dd30b1060b7b38">uniform</a> <a class="code" href="structmat4.html">mat4</a> <a class="code" href="_shadow_map__shadowmap_8vert.html#a540bf616d3c01b1f56c30faeee1f0423">u_m4LightP</a>;</div>
<div class="line"></div>
<div class="line">varying <a class="code" href="structvec4.html">vec4</a> <a class="code" href="_shadow_map__shadow_8frag.html#a796451b3e0aeefd7f2f7713dacaafbaf">v_v4TexCoord</a>;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmat4.html">mat4</a> biasMat = <a class="code" href="structmat4.html">mat4</a>(0.5, 0.0, 0.0, 0.0,</div>
<div class="line">                              0.0, 0.5, 0.0, 0.0,</div>
<div class="line">                              0.0, 0.0, 1.0, 0.0,</div>
<div class="line">                              0.5, 0.5, 0.0, 1.0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Calculate vertex position, which is being seen from the light. */</span></div>
<div class="line">    v_v4TexCoord =  u_m4LightP * u_m4LightV * u_m4M * <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8vert.html#aad7497bbca5d4d9f90e5a1503a832127">a_v4Position</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Normalize texture coords from -1..1 to 0..1 now, before projection. */</span></div>
<div class="line">    v_v4TexCoord =  biasMat * <a class="code" href="_shadow_map__shadow_8frag.html#a796451b3e0aeefd7f2f7713dacaafbaf">v_v4TexCoord</a>;</div>
<div class="line"></div>
<div class="line">    ...</div>
<div class="line">    <span class="comment">/* You can do some other computations here. For example, lighting, coordinates, clipping etc. */</span></div>
<div class="line">    ...</div>
<div class="line"></div>
<div class="line">    gl_Position = u_m4MVP * <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8vert.html#aad7497bbca5d4d9f90e5a1503a832127">a_v4Position</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Fragment shader:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#version 100</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><a class="code" href="glutil_8cpp.html#a2c5c3c4ce30783b590dd30b1060b7b38">uniform</a> <a class="code" href="shading__pass__shader__mrt_8frag.html#a1b6989ab661a266dc716cab5376599ca">sampler2D</a> <a class="code" href="_shadow_map__shadowmap_8frag.html#a95871eecface19be7ae41dc41381b84d">u_s2dShadowMap</a>;</div>
<div class="line"></div>
<div class="line">varying <a class="code" href="structvec4.html">vec4</a> <a class="code" href="_shadow_map__shadow_8frag.html#a796451b3e0aeefd7f2f7713dacaafbaf">v_v4TexCoord</a>;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Draw main scene - read and compare shadow map. */</span></div>
<div class="line">    <a class="code" href="structvec2.html">vec2</a> vfDepth = texture2DProj(u_s2dShadowMap, v_v4TexCoord).xy;</div>
<div class="line">    <span class="keywordtype">float</span> fDepth = (vfDepth.<a class="code" href="structvec2.html#a002d3519d48fe3cd79729b5b0ded74bf">x</a> * 10.0 + vfDepth.<a class="code" href="structvec2.html#a6d28b12b511da692550fc9d37b4e9b1d">y</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Unpack the light distance. See how it is packed in the shadow.frag file. */</span></div>
<div class="line">    <span class="keywordtype">float</span> fLDepth = (10.0 - v_v4TexCoord.z) + 0.1 - fDepth ;</div>
<div class="line">    <span class="keywordtype">float</span> fLight = 1.0;</div>
<div class="line">    <span class="keywordflow">if</span>(fDepth &gt; 0.0 &amp;&amp; fLDepth &lt; 0.0)</div>
<div class="line">    {</div>
<div class="line">        fLight = 0.2;</div>
<div class="line">        <span class="comment">/* Make sure there is no specular effect on obscured fragments. */</span></div>
<div class="line">        intensitySpecular = 0.0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ...</div>
<div class="line">    <span class="comment">/* You can do some other computations here. For example, lighting, texturing, fog etc. */</span></div>
<div class="line">    ...</div>
<div class="line"></div>
<div class="line">    gl_FragColor = <a class="code" href="structvec4.html">vec4</a>(FinalColor.rgb * fLight, FinalColor.a);</div>
<div class="line">}</div>
</div><!-- fragment --><p>From the above shaders, one can see that the vertex position is literally calculated twice; once in lighting space and once in camera space. First the vertex is being calculated in the light space (as the camera would be looking at the scene from the light source). This is the same way of doing transformation as it is usually done for vertices but in this case the vertex is being multiplied by the light transformation matrix instead of a camera.</p>
<div class="fragment"><div class="line"><span class="comment">/* Calculate vertex position, which is being seen from the light. */</span></div>
<div class="line">v_v4TexCoord = u_m4LightP * u_m4LightV * u_m4M * <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8vert.html#aad7497bbca5d4d9f90e5a1503a832127">a_v4Position</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">   Where:</span></div>
<div class="line"><span class="comment">       u_m4LightP    A projection matrix, which should be exactly the same as the camera&#39;s</span></div>
<div class="line"><span class="comment">       u_m4LightV    A view matrix from the light position and orientation</span></div>
<div class="line"><span class="comment">       u_m4M         A model matrix, transformation (position, rotation, scale) of an object of which the current vertex is being calculated</span></div>
<div class="line"><span class="comment">       a_v4Position  A vertex position in the current object</span></div>
<div class="line"><span class="comment"> */</span></div>
</div><!-- fragment --><p>Every time the vertex is calculated according to the above formula, the position is eventually represented in NDC (Normalized Device Coordinates) space, which is in the range [-1, 1]. Since the fragment distance is going to be read from the shadow texture the coordinates should be in the range of [0, 1]. For this reason we have to multiply the X and Y values by 0.5 and then add 0.5 to each. This transformation is shown below:</p>
<div class="fragment"><div class="line"><span class="comment">/* Calculate vertex position, which is being seen from the light. */</span></div>
<div class="line">v_v4TexCoord =  u_m4LightP * u_m4LightV * u_m4M * <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8vert.html#aad7497bbca5d4d9f90e5a1503a832127">a_v4Position</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Normalize texture coords from -1..1 to 0..1 now, before projection. */</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structmat4.html">mat4</a> biasMat = <a class="code" href="structmat4.html">mat4</a>(0.5, 0.0, 0.0, 0.0,</div>
<div class="line">                          0.0, 0.5, 0.0, 0.0,</div>
<div class="line">                          0.0, 0.0, 1.0, 0.0,</div>
<div class="line">                          0.5, 0.5, 0.0, 1.0);</div>
<div class="line">v_v4TexCoord =  biasMat * <a class="code" href="_shadow_map__shadow_8frag.html#a796451b3e0aeefd7f2f7713dacaafbaf">v_v4TexCoord</a>;</div>
</div><!-- fragment --><p>The final position, which is already in [0, 1] range, is passed to the fragment shader. The fragment shader fetches the distance from the shadow texture and compares it to the actual distance to the light. If the fetched distance is shorter, the fragment is in shadow. Otherwise it is out in the open and lit by the light. Below is a snippet of code showing the distance comparison in the fragment program:</p>
<div class="fragment"><div class="line"><span class="comment">/* Fetch and unpack the light distance from the shadow texture. */</span></div>
<div class="line"><a class="code" href="structvec2.html">vec2</a> vfDepth = texture2DProj(u_s2dShadowMap, v_v4TexCoord).xy;</div>
<div class="line"><span class="keywordtype">float</span> fDepth = (vfDepth.<a class="code" href="structvec2.html#a002d3519d48fe3cd79729b5b0ded74bf">x</a> * 10.0 + vfDepth.<a class="code" href="structvec2.html#a6d28b12b511da692550fc9d37b4e9b1d">y</a>);</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Convert the actual distance in the same manner as it is stored in the shadow texture. */</span></div>
<div class="line"><span class="keywordtype">float</span> fLDepth = (10.0 - v_v4TexCoord.z) + 0.1 - fDepth ;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* First assume the fragment is not in shadow. */</span></div>
<div class="line"><span class="keywordtype">float</span> fLight = 1.0;</div>
<div class="line"><span class="keywordflow">if</span>(fDepth &gt; 0.0 &amp;&amp; fLDepth &lt; 0.0)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Now the fragment is definitely in shadow. */</span></div>
<div class="line">    fLight = 0.2;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="shadowMappingReferences"></a>
References</h1>
<ul>
<li>Shadow Mapping; <a href="http://www.paulsprojects.net/tutorials/smt/smt.html">http://www.paulsprojects.net/tutorials/smt/smt.html</a></li>
<li>Shadow Mapping; <a href="http://en.wikipedia.org/wiki/Shadow_mapping">http://en.wikipedia.org/wiki/Shadow_mapping</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>
    <li class="footer">
        <a class="copyright" href="http://www.arm.com/">(C) ARM Ltd. 2013</a>
    </li>
  </ul>
</div>
</body>
</html>
